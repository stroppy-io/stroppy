syntax = "proto3";

package panel;

import "crossplane/resource.proto";
import "crossplane/types.proto";
import "google/protobuf/empty.proto";
import "panel/run.proto";
import "panel/types.proto";
import "protopgx/pgx.proto";
import "validate/validate.proto";

option go_package = "github.com/stroppy-io/stroppy-cloud-panel/internal/proto/panel";


// ----------------------------------------__RESOURCES_SERVICE__--------------------------------------------------------

message CloudResource {
    enum Status {
        STATUS_UNSPECIFIED = 0;
        // status for CloudAutomation
        STATUS_CREATING = 1;
        STATUS_WORKING = 2;
        STATUS_DESTROYING = 3;
        STATUS_DESTROYED = 4;
        STATUS_DEGRADED = 5;
    }
    option (sql.sql_table) = {
        generate: true
        table_name: "cloud_resources"
    };
    message TreeNode {
        Ulid id = 1 [(validate.rules).string.len = 26];
        CloudResource resource = 2 [(sql.sql_field).embedded_message = true];
        repeated TreeNode children = 3 [(sql.sql_field).embedded_message = true];
    }
    Ulid id = 1 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {primary_key: true}
        }
    ];
    Timing timing = 2 [(sql.sql_field).embedded_message = true];
    Status status = 3 [(validate.rules).enum.defined_only = true];
    crossplane.ResourceWithStatus resource = 4 [
        (sql.sql_field).embedded_message = true
    ];
    optional Ulid parent_resource_id = 5 [(sql.sql_field) = {sql_type: {type: TEXT,user_cast: true}}];
}

service ResourcesService {
    rpc GetResource (Ulid) returns (CloudResource.TreeNode); // get all resource tree
}


// ----------------------------------------__AUTOMATE_SERVICE__---------------------------------------------------------

message CloudAutomation {
    option (sql.sql_table) = {
        generate: true
        table_name: "cloud_automations"
    };
    message List {
        repeated CloudAutomation automations = 1;
    }
    Ulid id = 1 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {primary_key: true}
        }
    ];
    Timing timing = 2 [(sql.sql_field).embedded_message = true];
    Status status = 3 [(validate.rules).enum.defined_only = true];
    Ulid author_id = 4 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {constraint: "NOT NULL REFERENCES users(id) ON DELETE CASCADE"}
        }
    ];
    Ulid database_root_resource_id = 5 [(sql.sql_field) = {sql_type: {type: TEXT,user_cast: true}}];
    Ulid workload_root_resource_id = 6 [(sql.sql_field) = {sql_type: {type: TEXT,user_cast: true}}];
    optional Ulid stroppy_run_id = 7 [(sql.sql_field) = {sql_type: {type: TEXT,user_cast: true}}];
}


message ListAutomationsRequest {
    optional int32 limit = 1;
    optional int32 offset = 2;

    optional bool only_mine = 3;
    // order by
    optional Status order_by_status = 4;
    optional bool order_by_status_descending = 5;
    optional OrderByTimestamp order_by_created_at = 6;
}

message RunAutomationRequest {
    Database database = 1 [(sql.sql_field).serialized_message = true];
    Workload workload = 2 [(sql.sql_field).serialized_message = true];
    crossplane.SupportedCloud using_cloud_provider = 3 [(validate.rules).enum.const = 1]; // now it's YandexCloud only
}

service AutomateService {
    rpc GetAutomation (Ulid) returns (CloudAutomation);
    rpc ListAutomations (ListAutomationsRequest) returns (CloudAutomation.List);
    rpc RunAutomation (RunAutomationRequest) returns (RunRecord);
    rpc CancelAutomation (Ulid) returns (google.protobuf.Empty);
}