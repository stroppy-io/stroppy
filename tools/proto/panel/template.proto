syntax = "proto3";

package panel;

import "crossplane/deployment.proto";
import "crossplane/types.proto";
import "google/protobuf/empty.proto";
import "panel/types.proto";
import "protopgx/pgx.proto";
import "validate/validate.proto";
import "google/protobuf/wrappers.proto";

option go_package = "github.com/stroppy-io/stroppy-cloud-panel/internal/proto/panel";

// ----------------------------------------__TEMPLATE_SERVICE__---------------------------------------------------------

message Template {
    option (sql.sql_table) = {
        generate: true
        table_name: "templates"
    };
    message DatabaseDeployment {
        string prebuilt_image_id = 1 [(validate.rules).string.min_len = 1];
    }
    message MachineDeployment {
        crossplane.MachineInfo machine_info = 2 [(sql.sql_field).embedded_message = true];
    }
    message StroppyDeployment {
        repeated crossplane.FsFile files = 1;
        optional string cmd = 2 [(validate.rules).string.min_len = 1];
    }
    message List {repeated Template templates = 1;}
    Ulid id = 1 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {primary_key: true}
        }
    ];
    Timing timing = 2 [(sql.sql_field).embedded_message = true];
    string name = 3 [(validate.rules).string = {min_len: 3,max_len: 255}];
    Ulid author_id = 4 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {constraint: "NOT NULL REFERENCES users(id) ON DELETE CASCADE"}
        }
    ];
    bool is_default = 5;
    repeated Tag tags = 6 [(sql.sql_field).sql_type = {type: TEXT,user_cast: true}];
    oneof template_data {
        MachineDeployment machine_deployment = 101;
        DatabaseDeployment database_deployment = 102;
        StroppyDeployment stroppy_deployment = 103;
    }
}

message SearchTemplatesRequest {
    string name = 1 [(validate.rules).string.min_len = 1];
    Tag.List tags_list = 2;
}

service TemplateService {
    rpc ListTemplatesTags (google.protobuf.Empty) returns (Tag.List);
    rpc SearchTemplates (SearchTemplatesRequest) returns (Template.List);
    rpc GetTemplateKvs (Ulid) returns (KV.Map); // by template id
    rpc GetTemplate (Ulid) returns (Template);
    // Admins only
    rpc CreateTemplate (Template) returns (Template);
    rpc UpdateTemplate (Template) returns (Template);
    rpc DeleteTemplate (Ulid) returns (google.protobuf.Empty);
}

// ----------------------------------------__KV_SERVICE__---------------------------------------------------------------

message KvTable {
    option (sql.sql_table) = {
        generate: true
        table_name: "kv_infos"
    };
    Timing timing = 2 [(sql.sql_field).embedded_message = true];
    string key = 4 [
        (validate.rules).string.min_len = 1,
        (sql.sql_field).constraints = {primary_key: true}
    ];
    KV.Info info = 5 [(sql.sql_field).serialized_message = true];
}

service KvService {
    rpc ListKvs (google.protobuf.Empty) returns (KV.Map);
    rpc PutKv (KV) returns (google.protobuf.Empty);
    rpc UpdateKv (KV) returns (google.protobuf.Empty);
    rpc DeleteKv (google.protobuf.StringValue) returns (google.protobuf.Empty);
}
