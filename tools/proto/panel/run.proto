syntax = "proto3";

package panel;

import "crossplane/types.proto";
import "panel/template.proto";
import "panel/types.proto";
import "proto/stroppy/cloud.proto";
import "protopgx/pgx.proto";
import "validate/validate.proto";

option go_package = "github.com/stroppy-io/stroppy-cloud-panel/internal/proto/panel";

message CloudRunParams {
    message MachineInstanceParams {
        Template machine_deployment_template = 1;
        crossplane.SshUser ssh_user = 2 [(sql.sql_field).embedded_message = true];
        bool public_ip = 3;
    }
    message StroppyInstanceParams {
        // now support only YandexCloud
        crossplane.SupportedCloud supported_cloud = 1 [(validate.rules).enum.defined_only = true];

        // now support only single node
        MachineInstanceParams machine_instance = 2;
        Template stroppy_deployment_template = 3;
        KV.Map env_kv = 4 [(sql.sql_field).serialized_message = true];
    }
    message DatabaseInstanceParams {
        // now support only YandexCloud
        crossplane.SupportedCloud supported_cloud = 1 [(validate.rules).enum.defined_only = true];

        // now support only single node
        Template database_deployment_template = 2;
        MachineInstanceParams machine_instance = 3;
    }


    StroppyInstanceParams stroppy_instance_template = 2 [(sql.sql_field).serialized_message = true];
    // if not present, it means that database deployed outside of cloud
    optional DatabaseInstanceParams database_instance_template = 3 [(sql.sql_field).serialized_message = true];
}

message RunRecord {
    option (sql.sql_table) = {
        generate: true
        table_name: "run_records"
    };
    message List {
        repeated RunRecord records = 1;
    }
    Ulid id = 1 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {primary_key: true}
        }
    ];
    Ulid author_id = 2 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {constraint: "NOT NULL REFERENCES users(id) ON DELETE CASCADE"}
        }
    ];
    Timing timing = 3 [(sql.sql_field).embedded_message = true];
    stroppy.Status status = 4 [(validate.rules).enum.defined_only = true];
    stroppy.StroppyRun run_info = 5 [(sql.sql_field).serialized_message = true];

    // stroppy run metrics
    Tps tps = 6 [(sql.sql_field).serialized_message = true];
    string grafana_dashboard_url = 7;

    optional Ulid workflow_id = 8 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
        }
    ];
    // its optional cause stroppy can send RunRecord without deployment anything
    optional CloudRunParams cloud_run_params = 9 [(sql.sql_field).serialized_message = true];

    repeated RunRecordStep steps = 11 [(sql.sql_relation).one_to_many = {
        ref_name: "run_id"
        existed_field: true
        on_delete_cascade: true
    }];
}

message RunRecordStep {
    option (sql.sql_table) = {
        generate: true
        table_name: "run_record_steps"
    };
    message List {repeated RunRecordStep steps = 1;}
    Ulid id = 1 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {primary_key: true}
        }
    ];
    Timing timing = 2 [(sql.sql_field).embedded_message = true];
    Ulid run_id = 3 [
        (sql.sql_field) = {sql_type: {type: TEXT,user_cast: true},
            constraints: {constraint: "NOT NULL REFERENCES run_records(id) ON DELETE CASCADE"}
        }
    ];
    stroppy.Status status = 4 [(validate.rules).enum.defined_only = true];
    stroppy.StroppyStepRun step_info = 5 [(sql.sql_field).serialized_message = true];
}

// ----------------------------------------__RUN_SERVICE__--------------------------------------------------------------

message ListRunsRequest {
    optional int32 limit = 1;
    optional int32 offset = 2;
    string id = 7;
    bool only_mine = 10;
    optional stroppy.Status status = 3; // sort by status
    Tag.List stroppy_tags = 4;
    Tag.List database_tags = 5;
    // order
    Tps.Order tps_order = 6;
}

service RunService {
    rpc ListRuns (ListRunsRequest) returns (RunRecord.List);
    rpc RunStroppyInCloud (CloudRunParams) returns (RunRecord);
}

