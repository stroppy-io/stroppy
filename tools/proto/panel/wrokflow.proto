syntax = "proto3";

package panel;

import "crossplane/deployment.proto";
import "google/protobuf/any.proto";
import "panel/run.proto";
import "panel/template.proto";
import "panel/types.proto";
import "protopgx/pgx.proto";

option go_package = "github.com/stroppy-io/stroppy-cloud-panel/internal/proto/panel";

message Workflow {
    option (sql.sql_table) = {
        generate: true
        table_name: "workflows"
    };
    Ulid id = 1 [
        (sql.sql_field) = {
            sql_type: {type: TEXT,user_cast: true}
            constraints: {primary_key: true}
        }
    ];
    Timing timing = 2 [(sql.sql_field).embedded_message = true];
    repeated WorkflowTask tasks = 3 [(sql.sql_relation).one_to_many = {
        ref_name: "workflow_id"
        existed_field: true
        on_delete_cascade: true
    }];
    repeated WorkflowEdge edges = 4 [(sql.sql_relation).one_to_many = {
        ref_name: "workflow_id"
        on_delete_cascade: true
    }];
}


message WorkflowTask {
    option (sql.sql_table) = {
        generate: true
        table_name: "workflow_tasks"
    };
    message DeployDatabase {
        message Input {
            CloudRunParams.DatabaseInstanceParams database_instance_params = 1; // input
        }
        message Output {
            optional crossplane.Deployment database_deployment = 1; // output
        }
    }
    message DeployStroppy {
        message Input {
            Ulid stroppy_run_id = 1; // input
            CloudRunParams.StroppyInstanceParams stroppy_instance_params = 2; // input
            crossplane.Deployment database_deployment = 3; // input
        }
        message Output {
            optional crossplane.Deployment stroppy_deployment = 1; // output
        }
    }
    message CollectRunResults {
        message Input {
            Ulid stroppy_run_id = 1;
        }
        message Output {}
    }
    enum Type {
        TYPE_UNSPECIFIED = 0;
        TYPE_DEPLOY_DATABASE = 1;
        TYPE_DEPLOY_STROPPY = 2;
        TYPE_COLLECT_RUN_RESULTS = 3;
    }
    enum Status {
        STATUS_UNSPECIFIED = 0;
        STATUS_PENDING = 1;
        STATUS_RUNNING = 2;
        STATUS_RETRYING = 3;
        STATUS_COMPLETED = 4;
        STATUS_FAILED = 5;
        STATUS_CANCELLED = 6;
    }
    string id = 1 [(sql.sql_field) = {constraints: {primary_key: true}}];
    Timing timing = 2 [(sql.sql_field).embedded_message = true];
    Type task_type = 3;
    Status status = 4;
    string workflow_id = 5;
    bool cleaned_up = 6;
    string on_worker = 7;
    Retry.State retry_state = 8 [(sql.sql_field).serialized_message = true];
    repeated LogRecord logs = 9 [(sql.sql_field).serialized_message = true];
    Retry retry_settings = 10 [(sql.sql_field).serialized_message = true];
    google.protobuf.Any input = 11 [(sql.sql_field).serialized_message = true];
    google.protobuf.Any output = 12 [(sql.sql_field).serialized_message = true];
    Metadata metadata = 13 [(sql.sql_field).serialized_message = true];
}

message WorkflowEdge {
    option (sql.sql_table) = {
        generate: true
        table_name: "workflow_edges"
    };
    string from_id = 2 [
        (sql.sql_field) = {
            constraints: {constraint: "NOT NULL REFERENCES workflow_tasks(id) ON DELETE CASCADE"}
        }
    ];
    string to_id = 3 [
        (sql.sql_field) = {
            constraints: {constraint: "NOT NULL REFERENCES workflow_tasks(id) ON DELETE CASCADE"}
        }
    ];
    Metadata metadata = 4;
}



// ----------------------------------------__WORKFLOW_SERVICE__---------------------------------------------------------

service WorkflowService {
    rpc GetWorkflow (Ulid) returns (Workflow);
    rpc CancelWorkflow (Ulid) returns (Workflow);
}