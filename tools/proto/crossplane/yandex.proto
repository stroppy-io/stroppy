syntax = "proto3";

package crossplane;

import "crossplane/types.proto";
import "validate/validate.proto";

option go_package = "github.com/stroppy-io/stroppy-cloud-panel/internal/proto/crossplane";


message YandexCloud {
    enum ResourceKind {
        RESOURCE_KIND_UNSPECIFIED = 0;
        INSTANCE = 1; // Yandex Cloud VM Instance
        NETWORK = 2; // Yandex Cloud Network
        SUBNET = 3; // Yandex Cloud Subnet
    }
    message Network {
        string name = 1 [(validate.rules).string.min_len = 1];
    }
    message Subnet {
        message NetworkIdRef {
            string name = 1 [(validate.rules).string.min_len = 1];
        }
        string name = 1 [(validate.rules).string.min_len = 1];
        NetworkIdRef network_id_ref = 2 [(validate.rules).message.required = true];
        repeated string v4_cidr_blocks = 3 [(validate.rules).string.min_len = 1];
    }
    message Vm {
        message Resources {
            uint32 cores = 1 [(validate.rules).uint32.gte = 1];
            uint32 memory = 2 [(validate.rules).uint32.gte = 1]; // in GB
        }
        message Disk {
            message InitializeParams {
                string image_id = 1 [(validate.rules).string.min_len = 1];
            }
            repeated InitializeParams initialize_params = 1 [(validate.rules).repeated.min_items = 1];
        }
        message NetworkInterface {
            OnlyNameRef subnet_id_ref = 1 [(validate.rules).message.required = true];
            bool nat = 2;
            string ip_address = 3;
        }
        string name = 2 [(validate.rules).string.min_len = 1];
        string platform_id = 3 [(validate.rules).string.const = "standard-v2"];
        string zone = 4 [(validate.rules).string.const = "ru-central1-d"];
        repeated Resources resources = 5 [(validate.rules).message.required = true];
        repeated Disk boot_disk = 6 [(validate.rules).repeated.min_items = 1];
        repeated NetworkInterface network_interface = 7 [(validate.rules).repeated.min_items = 1];
        map<string, string> metadata = 8 [(validate.rules).message.required = true];
    }

    // converted to crossplane k8s yaml
    message ResourceDef {
        message Spec {
            enum DeletionPolicy {
                DELETION_POLICY_UNSPECIFIED = 0;
                DELETE = 1;
                ORPHAN = 2;
            }
            Ref write_connection_secret_to_ref = 1 [(validate.rules).message.required = true];
            string deletion_policy = 2 [(validate.rules).enum.defined_only = true]; // converted from DeletionPolicy
            map<string, string> provider_config_ref = 3;
            oneof for_provider {
                YandexCloud.Vm yandex_cloud_vm = 100 [(validate.rules).message.required = true];
                YandexCloud.Network yandex_cloud_network = 101 [(validate.rules).message.required = true];
                YandexCloud.Subnet yandex_cloud_subnet = 102 [(validate.rules).message.required = true];
            }
        }
        string api_version = 2 [(validate.rules).message.required = true];
        string kind = 1 [(validate.rules).message.required = true];
        Metadata metadata = 3;
        Spec spec = 4 [(validate.rules).message.required = true];
    }

    message VmStrategy {
        message Scripting {
            message FileToWrite {
                string path = 1 [(validate.rules).string.min_len = 1];
                bytes content = 2 [(validate.rules).bytes.min_len = 1];
            }
            string cmd = 1 [(validate.rules).string.min_len = 1];
            string workdir = 2 [(validate.rules).string.min_len = 1];
            map<string, string> env = 3;
            repeated FileToWrite files_to_write = 4 [(validate.rules).repeated.min_items = 1];
        }
        message PrebuiltImage {
            string image_id = 1 [(validate.rules).string.min_len = 1];
        }
        string base_image_id = 2 [(validate.rules).string.min_len = 1];
        bool public_ip = 3;
        oneof strategy {
            Scripting scripting = 1;
            PrebuiltImage prebuilt_image = 11;
        }
    }
}
