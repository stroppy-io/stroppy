datasource:
  Ec2:
    strict_id: false
ssh_pwauth: no
users:
  - name: st-t-postgres
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC4euZHbJ7gotvGExbz7MizamlxXRNoggVDV6uM6bXamgCCb3SmdhyByAW8/1PcnV0HJV+HhSwLGNxhF7chH/um68tlz3SUaCQLjwEyemxeXqQHj2ORs6h903tkHE1UbDBNPYPgyD+u8fg9/PlMweR8w0DikwMCUQ40cmYW72bSVKSHtozCRXSNjKyAsIa0Iay7Vj2FGT4k0em8aA2xONP+Y4xUiz4bUKksxzCZnPEWjrT6noS6eV7q0G0eDIUFWnjnlFZSxl/kOPDCFRc6FyMZe3zrB5atnR7y0EviuaNLPEmVcsdyoK8fyRasfPzIrMQywRaFAYTYp0O9gGU27+GJ
write_files:
  - path: "/usr/local/etc/docker-start.sh"
    permissions: "755"
    content: |
      #!/bin/bash

      # Docker
      echo "Installing Docker"
      sudo apt update -y && sudo apt install docker.io -y
      echo "Grant user access to Docker"
      sudo usermod -aG docker ${USER}
      newgrp docker

      # Docker Compose
      echo "Installing Docker Compose"
      sudo apt install docker-compose-v2 -y

    defer: true
  - path: "/home/st-t-postgres/oriole/docker-compose.yaml"
    permissions: "644"
    content: |
      services:
        orioledb:
          image: orioledb/orioledb:latest-pg17
          container_name: orioledb
          hostname: orioledb
          restart: unless-stopped
          environment:
            POSTGRES_USER: st-t-postgres
            POSTGRES_PASSWORD: st-t-postgres-pass
            POSTGRES_DB: st-t-postgres
            PGDATA: /var/lib/postgresql/data
          ports:
            - "54321:5432"
          volumes:
            - orioledb_data:/var/lib/postgresql/data
            - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro,Z
            - ./pg_hba.conf:/etc/postgresql/pg_hba.conf:ro,Z
            - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro,Z
          command: >
            postgres
            -c config_file=/etc/postgresql/postgresql.conf
            -c hba_file=/etc/postgresql/pg_hba.conf
          healthcheck:
            test: ["CMD-SHELL", "pg_isready -U st-t-postgres"]
            interval: 10s
            timeout: 5s
            retries: 5
          networks:
            - oriole_network

        postgres_exporter:
          image: prometheuscommunity/postgres-exporter:v0.18.0
          container_name: postgres_exporter
          hostname: postgres_exporter
          restart: unless-stopped
          environment:
            DATA_SOURCE_NAME: "postgresql://st-t-postgres:st-t-postgres-pass@orioledb:5432/st-t-postgres?sslmode=disable"
          ports:
            - "9187:9187"
          depends_on:
            orioledb:
              condition: service_healthy
          networks:
            - oriole_network

        node_exporter:
          image: prom/node-exporter:v1.9.1
          container_name: node_exporter
          hostname: node_exporter
          restart: unless-stopped
          ports:
            - "9100:9100"
          command:
            - "--path.rootfs=/host"
          volumes:
            - /:/host:ro,rslave,Z
          networks:
            - oriole_network

        vmagent:
          image: victoriametrics/vmagent:v1.126.0
          container_name: vmagent
          hostname: vmagent
          restart: unless-stopped
          ports:
            - "8429:8429"
          volumes:
            - vmagent_data:/vmagentdata
            - ./vmagent-scrape.yml:/etc/vmagent/scrape.yml:ro,Z
          command:
            - "-promscrape.config=/etc/vmagent/scrape.yml"
            - "-remoteWrite.url=https://vminsert.stroppy.io/insert/multitenant/prometheus/api/v1/write"
            - "-remoteWrite.tmpDataPath=/vmagentdata"
            - "-remoteWrite.basicAuth.username=vminsert"
            - "-remoteWrite.basicAuth.password=PGkbvc4pilgWUO7EBJ4z1jbkd"
            - "-remoteWrite.label=host=orioledb-docker"
            - "-remoteWrite.label=instance=orioledb-docker"
          depends_on:
            - postgres_exporter
            - node_exporter
          networks:
            - oriole_network

      volumes:
        orioledb_data:
          driver: local
        vmagent_data:
          driver: local

      networks:
        oriole_network:
          driver: bridge

    defer: true
  - path: "/home/st-t-postgres/oriole/init-db.sh"
    permissions: "755"
    content: |
      #!/bin/bash
      set -e

      # This script runs during container initialization
      # It grants monitoring privileges to the application user

      psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
          -- Grant monitoring privileges for exporters
          GRANT pg_monitor TO "$POSTGRES_USER";

          -- Ensure the user can connect
          SELECT 'Database initialization complete' AS status;
      EOSQL

    defer: true
  - path: "/home/st-t-postgres/oriole/pg_hba.conf"
    permissions: "644"
    content: |
      # PostgreSQL Client Authentication Configuration File
      # Ported from oriole_server.sh setup script

      # TYPE  DATABASE        USER            ADDRESS                 METHOD

      # "local" is for Unix domain socket connections only
      local   all             all                                     trust

      # IPv4 local connections:
      host    all             all             127.0.0.1/32            trust

      # IPv6 local connections:
      host    all             all             ::1/128                 trust

      # Allow replication connections from localhost, by a user with the
      # replication privilege.
      local   replication     all                                     trust
      host    replication     all             127.0.0.1/32            trust
      host    replication     all             ::1/128                 trust

      # auto-added app user
      # Allow the app user from anywhere with password auth (IPv4 and IPv6)
      # For production, restrict the address ranges instead of 0.0.0.0/0 and ::/0.
      host    all     st-t-postgres    0.0.0.0/0       scram-sha-256
      host    all     st-t-postgres    ::/0            scram-sha-256

    defer: true
  - path: "/home/st-t-postgres/oriole/postgresql.conf"
    permissions: "644"
    content: |
      # PostgreSQL Configuration File
      # Ported from oriole_server.sh setup script

      # Connection Settings
      listen_addresses = '*'
      port = 5432
      max_connections = 500

      # Monitoring and Statistics
      track_activities = on
      track_activity_query_size = 1024
      track_counts = on
      track_io_timing = on
      track_wal_io_timing = on
      track_functions = all
      stats_fetch_consistency = cache

      # Timeouts
      statement_timeout = 0  # for long running init statements

      # Memory Settings (8 cores, 32 GB)
      shared_buffers = 10GB
      effective_cache_size = 24GB
      maintenance_work_mem = 2GB
      work_mem = 16513kB
      huge_pages = try

      # WAL Settings
      wal_buffers = 16MB
      min_wal_size = 2GB
      max_wal_size = 8GB
      checkpoint_completion_target = 0.9

      # Query Planner
      default_statistics_target = 100
      random_page_cost = 1.1
      effective_io_concurrency = 300

      # Parallel Query Settings
      max_worker_processes = 8
      max_parallel_workers_per_gather = 4
      max_parallel_workers = 8
      max_parallel_maintenance_workers = 4

      # Logging (optional but recommended)
      log_destination = 'stderr'
      logging_collector = on
      log_directory = 'log'
      log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
      log_rotation_age = 1d
      log_rotation_size = 100MB
      log_line_prefix = '%m [%p] %u@%d '
      log_timezone = 'UTC'

      # Locale and Formatting
      datestyle = 'iso, mdy'
      timezone = 'UTC'
      lc_messages = 'C'
      lc_monetary = 'C'
      lc_numeric = 'C'
      lc_time = 'C'
      default_text_search_config = 'pg_catalog.english'

    defer: true
  - path: "/home/st-t-postgres/oriole/vmagent-scrape.yml"
    permissions: "644"
    content: |
      global:
        scrape_interval: 15s

      scrape_configs:
        - job_name: 'node'
          static_configs:
            - targets: ['node_exporter:9100']
          relabel_configs:
            - target_label: instance
              replacement: "orioledb-docker"
          metric_relabel_configs:
            - source_labels: [__name__]
              regex: 'go_.*'
              action: drop

        - job_name: 'postgres'
          static_configs:
            - targets: ['postgres_exporter:9187']
          relabel_configs:
            - target_label: instance
              replacement: "orioledb-docker"
          metric_relabel_configs:
            - source_labels: [__name__]
              regex: 'go_.*'
              action: drop

    defer: true
  - path: "/usr/local/etc/docker-main.sh"
    permissions: "755"
    content: |
      #!/bin/bash

      # Navigate to the oriole directory
      cd /home/st-t-postgres/oriole

      # Run docker compose
      echo "Starting OrioleDB stack with Docker Compose"
      docker compose up -d

      # Show running containers
      echo "Running containers:"
      docker compose ps

      # Show logs
      echo "Recent logs:"
      docker compose logs --tail=50

    defer: true
runcmd:
  - [su, st-t-postgres, -c, "/usr/local/etc/docker-start.sh"]
  - [su, st-t-postgres, -c, "/usr/local/etc/docker-main.sh"]