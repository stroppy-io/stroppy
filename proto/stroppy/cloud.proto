syntax = "proto3";

package stroppy;

import "proto/stroppy/common.proto";
import "validate/validate.proto";
import "proto/stroppy/config.proto";
import "google/protobuf/empty.proto";
import "proto/stroppy/runtime.proto";

option go_package = "github.com/stroppy-io/stroppy/pkg/common/proto/stroppy";

/**
 * Status represents the status of a stroppy run or step run.
 */
enum Status {
    /** Run or step is idle */
    STATUS_IDLE = 0;
    /** Run or step is running */
    STATUS_RUNNING = 1;
    /** Run or step has completed successfully */
    STATUS_COMPLETED = 2;
    /** Run or step has failed */
    STATUS_FAILED = 3;
    /** Run or step has been cancelled */
    STATUS_CANCELLED = 4;
}

message StroppyStepRun {
    /** Unique identifier for the step run generated by stroppy-cli */
    stroppy.Ulid id = 1 [ (validate.rules).message.required = true ];
    /** Unique identifier for the parent stroppy run generated by stroppy-cli */
    stroppy.Ulid stroppy_run_id = 2
        [ (validate.rules).message.required = true ];
    /** Context for the step run */
    stroppy.StepContext context = 3
        [ (validate.rules).message.required = true ];
    /** Status of the step run */
    Status status = 4 [ (validate.rules).enum.defined_only = true ];
}

/**
 * StroppyRun represents a benchmark run on the stroppy cli.
 */
message StroppyRun {
    /** Unique identifier for the run generated by stroppy-cli */
    stroppy.Ulid id = 1 [ (validate.rules).message.required = true ];
    /** Status of the run */
    Status status = 2 [ (validate.rules).enum.defined_only = true ];
    /** Configuration for the benchmark run */
    stroppy.ConfigFile config = 3 [ (validate.rules).message.required = true ];
    /** Command used to run the benchmark */
    string cmd = 4 [ (validate.rules).string.min_len = 1 ];
}

/**
 * CloudStatusService is a service for notifying the cloud status of runs and
 * steps.
 */
service CloudStatusService {
    /** Notifies the cloud status of a benchmark run */
    rpc NotifyRun(StroppyRun) returns (google.protobuf.Empty);
    /** Notifies the cloud status of a benchmark step */
    rpc NotifyStep(StroppyStepRun) returns (google.protobuf.Empty);
}
